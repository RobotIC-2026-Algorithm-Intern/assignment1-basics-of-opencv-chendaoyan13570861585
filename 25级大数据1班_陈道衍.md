# 25级大数据1班 陈道衍 - 第一次作业  

> 特别鸣谢 **ChatGPT 5**，没有它的帮助我现在还在新建文件夹。  

~~主播第一次用 Markdown，这波语法库免费~~  

---

## 1. 代码思路  

### 1.1 `homework.py`  

>- 现在看来，~~好像也挺难的~~  
>- 用 `cv2.VideoCapture` 来读取视频，用 `.read()` 来逐帧读取视频  
>- `.read()` 下来的是一张**彩色图**，为了方便图像识别，需要把它转换成 **HSV** 形式  

```python
hsv = cv2.cvtColor(roi, cv2.COLOR_BGR2HSV_FULL)  # roi是你从frame截的区域
```

~~发现有点耗时间，水亿点~~


把每一帧转换成 HSV，再根据设定做掩码，简单降噪一下，用 `cv2.countNonZero()` 来统计目标颜色的像素数量，取最大值并判断是否大于阈值，最终决定球的颜色。  

---

### 1.2 `homework_class.py`  

>- 用 Class 让代码整体更有结构，可读性更高  
>- 在 `BallDetector` 中声明 `ColorRange` 类，能省不少事情  
>- 方法、成员之间的调用最容易搞晕，**尤其是实例的类别（列表、字典、元组）混淆不清**  
>- 多看 `def` 的输入输出，搞清楚调用关系，就差不多了  

---

### 1.3 `homework_json.py`  

>- 用 json 做 main() 里的初始化，把硬编码的参数提取出去  
>- **注意：json 中没有 tuple，要在 Python 里转回 tuple**  

---

## 2. 核心代码  

三份基本一样，我就放最折磨人的那个（`BallDetector.run`）：

```python
def run(self, ranges_dict, color_names,
        KERNEL=None, MIN_PIX=300, NO_BALL=0.01,
        COLOR_TEXT=None, rotate180=False):

    if COLOR_TEXT is None:
        COLOR_TEXT = {"null": (200, 200, 200)}

    while True:
        ret, frame = self.cap.read()
        if not ret:
            break
        if rotate180:
            frame = cv2.rotate(frame, cv2.ROTATE_180)

        cr = ColorRange(frame)
        cr.ranges = ranges_dict  # 注入颜色范围

        dic = {}
        for name in color_names:
            mask = cr.make_mask(name, KERNEL)
            if mask is None:
                continue
            frame_roi, mask_roi = self._apply_roi(frame, mask)
            dic[name] = cv2.countNonZero(mask_roi)

        # 默认无球
        label = "null"
        if dic:
            roi_area = frame_roi.shape[0] * frame_roi.shape[1]  # 长×宽
            # 筛选符合阈值的颜色
            check = {k:v for k,v in dic.items()
                     if v >= MIN_PIX and v/roi_area >= NO_BALL}
            if check:
                label = max(dic, key=dic.get)

        # 绘制结果
        if self.roi:
            x, y, w, h = self.roi
            cv2.rectangle(frame, (x,y), (x+w,y+h), (0,255,0), 2)
        cv2.putText(frame, label, (20,40),
                    cv2.FONT_HERSHEY_SIMPLEX, 1,
                    COLOR_TEXT.get(label, (0,255,0)), 2)

        cv2.imshow("Frame", frame)
        if cv2.waitKey(25) & 0xFF == 27:  # ESC退出
            break

    self.cap.release()
    cv2.destroyAllWindows()
```

---

![我的艾莉丝😭](homework/image-20240117142600734.png "my love")  
大哭 :sob:
